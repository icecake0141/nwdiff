# Copyright 2025 NW-Diff Contributors
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# This file was created or modified with the assistance of an AI (Large Language Model).
# Review required for correctness, security, and licensing.

services:
  nw-diff:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nw-diff-app
    environment:
      - DEVICE_PASSWORD=${DEVICE_PASSWORD}
      - NW_DIFF_API_TOKEN=${NW_DIFF_API_TOKEN}
      - HOSTS_CSV=/app/hosts.csv
      - APP_DEBUG=false
      - FLASK_RUN_HOST=0.0.0.0
      - FLASK_RUN_PORT=5000
    volumes:
      # Mount hosts.csv from a secure location
      - ./hosts.csv:/app/hosts.csv:ro
      # Persistent data volumes
      - nw-diff-logs:/app/logs
      - nw-diff-dest:/app/dest
      - nw-diff-origin:/app/origin
      - nw-diff-diff:/app/diff
      - nw-diff-backup:/app/backup
    networks:
      - nw-diff-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5000/').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  nginx:
    image: nginx:1.25-alpine
    container_name: nw-diff-nginx
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/certs:/etc/nginx/certs:ro
      - ./docker/.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - nw-diff
    networks:
      - nw-diff-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  nw-diff-logs:
  nw-diff-dest:
  nw-diff-origin:
  nw-diff-diff:
  nw-diff-backup:

networks:
  nw-diff-network:
    driver: bridge
