{% extends "base.html" %}

{% block title %}Application Logs{% endblock %}

{% block content %}
<h1 class="mb-4">Application Logs</h1>

<div class="mb-3">
    <button id="refreshBtn" class="btn btn-primary">Refresh Logs</button>
    <button id="autoRefreshToggle" class="btn btn-secondary">Auto-Refresh: OFF</button>
    <a href="{{ url_for('host_list') }}" class="btn btn-info">Back to Host List</a>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Log Viewer (Last 1000 lines)</h5>
    </div>
    <div class="card-body" style="background-color: #f8f9fa;">
        <div id="logContent" style="max-height: 600px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;">
{% for line in log_lines %}{{ line }}{% endfor %}
        </div>
    </div>
</div>

<div class="mt-3">
    <h5>API Access</h5>
    <p>You can also access logs programmatically via the API:</p>
    <code>GET {{ url_for('logs_api', _external=True) }}</code>
    <p class="mt-2">Query parameters:</p>
    <ul>
        <li><code>level</code>: Filter by log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)</li>
        <li><code>limit</code>: Maximum number of lines to return (default: 1000, max: 10000)</li>
        <li><code>tail</code>: If true, return the last N lines (default: true)</li>
    </ul>
    <p>Example: <code>{{ url_for('logs_api', _external=True) }}?level=ERROR&limit=100</code></p>
</div>

<script>
    let autoRefreshEnabled = false;
    let autoRefreshInterval = null;

    function refreshLogs() {
        fetch("{{ url_for('logs_view') }}")
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newContent = doc.getElementById('logContent').innerHTML;
                document.getElementById('logContent').innerHTML = newContent;
                // Scroll to bottom
                const logDiv = document.getElementById('logContent');
                logDiv.scrollTop = logDiv.scrollHeight;
            })
            .catch(error => console.error('Error refreshing logs:', error));
    }

    document.getElementById('refreshBtn').addEventListener('click', function() {
        refreshLogs();
    });

    document.getElementById('autoRefreshToggle').addEventListener('click', function() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const btn = document.getElementById('autoRefreshToggle');
        
        if (autoRefreshEnabled) {
            btn.textContent = 'Auto-Refresh: ON';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');
            // Refresh every 5 seconds
            autoRefreshInterval = setInterval(refreshLogs, 5000);
        } else {
            btn.textContent = 'Auto-Refresh: OFF';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    });

    // Auto-scroll to bottom on page load
    window.addEventListener('load', function() {
        const logDiv = document.getElementById('logContent');
        logDiv.scrollTop = logDiv.scrollHeight;
    });

    // Color-code log levels
    window.addEventListener('load', function() {
        const logDiv = document.getElementById('logContent');
        let html = logDiv.innerHTML;
        
        // Apply colors to different log levels
        html = html.replace(/- ERROR -/g, '<span style="color: #dc3545; font-weight: bold;">- ERROR -</span>');
        html = html.replace(/- CRITICAL -/g, '<span style="color: #dc3545; font-weight: bold; background-color: #f8d7da;">- CRITICAL -</span>');
        html = html.replace(/- WARNING -/g, '<span style="color: #ffc107; font-weight: bold;">- WARNING -</span>');
        html = html.replace(/- INFO -/g, '<span style="color: #17a2b8;">- INFO -</span>');
        html = html.replace(/- DEBUG -/g, '<span style="color: #6c757d;">- DEBUG -</span>');
        
        logDiv.innerHTML = html;
    });
</script>
{% endblock %}
