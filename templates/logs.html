{% extends "base.html" %}

{% block title %}Application Logs{% endblock %}

{% block content %}
<h1 class="mb-4">Application Logs</h1>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="btn-group mr-2" role="group">
            <button id="refreshBtn" class="btn btn-primary">Refresh Logs</button>
            <button id="autoRefreshToggle" class="btn btn-secondary">Auto-Refresh: OFF</button>
        </div>
        <div class="btn-group mr-2" role="group">
            <select id="limitSelector" class="form-control" style="display: inline-block; width: auto;">
                <option value="100">100 lines</option>
                <option value="500">500 lines</option>
                <option value="1000" selected>1000 lines</option>
                <option value="5000">5000 lines</option>
            </select>
        </div>
        <div class="btn-group mr-2" role="group">
            <select id="levelFilter" class="form-control" style="display: inline-block; width: auto;">
                <option value="">All Levels</option>
                <option value="DEBUG">DEBUG</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
                <option value="CRITICAL">CRITICAL</option>
            </select>
        </div>
        <div class="btn-group mr-2" role="group">
            <select id="refreshInterval" class="form-control" style="display: inline-block; width: auto;">
                <option value="5" selected>5 seconds</option>
                <option value="10">10 seconds</option>
                <option value="30">30 seconds</option>
                <option value="60">60 seconds</option>
            </select>
        </div>
        <a href="{{ url_for('host_list') }}" class="btn btn-info">Back to Host List</a>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-12">
        <input type="text" id="searchFilter" class="form-control" placeholder="Search logs...">
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">Log Viewer <span id="lineCount">({{ log_lines|length }} lines)</span></h5>
    </div>
    <div class="card-body" style="background-color: #f8f9fa;">
        <div id="logContent" style="max-height: 600px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;">
{% for line in log_lines %}{{ line }}{% endfor %}
        </div>
    </div>
</div>

<div class="mt-3">
    <h5>API Access</h5>
    <p>You can also access logs programmatically via the API:</p>
    <code>GET {{ url_for('logs_api', _external=True) }}</code>
    <p class="mt-2">Query parameters:</p>
    <ul>
        <li><code>level</code>: Filter by log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)</li>
        <li><code>limit</code>: Maximum number of lines to return (default: 1000, max: 10000)</li>
        <li><code>tail</code>: If true, return the last N lines (default: true)</li>
    </ul>
    <p>Example: <code>{{ url_for('logs_api', _external=True) }}?level=ERROR&limit=100</code></p>
</div>

<script>
    let autoRefreshEnabled = false;
    let autoRefreshInterval = null;
    let allLogLines = [];

    function refreshLogs() {
        const limit = document.getElementById('limitSelector').value;
        const level = document.getElementById('levelFilter').value;

        let url = "{{ url_for('logs_api') }}?limit=" + limit;
        if (level) {
            url += "&level=" + level;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                allLogLines = data.logs || [];
                applySearchFilter();
                updateLineCount(data.count);
            })
            .catch(error => {
                console.error('Error refreshing logs:', error);
                document.getElementById('logContent').innerHTML =
                    '<span style="color: red;">Error loading logs. Please try again.</span>';
            });
    }

    function applySearchFilter() {
        const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
        let filteredLines = allLogLines;

        if (searchTerm) {
            filteredLines = allLogLines.filter(line =>
                line.toLowerCase().includes(searchTerm)
            );
        }

        const logDiv = document.getElementById('logContent');
        // Use textContent to safely set the content without HTML parsing
        logDiv.textContent = filteredLines.join('\n');

        // Apply color coding
        colorCodeLogs(logDiv);

        // Scroll to bottom
        logDiv.scrollTop = logDiv.scrollHeight;

        // Update line count
        updateLineCount(filteredLines.length);
    }

    function colorCodeLogs(logDiv) {
        // Safely escape HTML and apply color coding using DOM methods
        const text = logDiv.textContent;
        const lines = text.split('\n');
        logDiv.innerHTML = '';

        lines.forEach(function(line) {
            const lineDiv = document.createElement('div');

            // Check for log levels and apply styling
            if (line.includes('- ERROR -')) {
                const parts = line.split('- ERROR -');
                lineDiv.appendChild(document.createTextNode(parts[0]));
                const errorSpan = document.createElement('span');
                errorSpan.style.color = '#dc3545';
                errorSpan.style.fontWeight = 'bold';
                errorSpan.textContent = '- ERROR -';
                lineDiv.appendChild(errorSpan);
                lineDiv.appendChild(document.createTextNode(parts.slice(1).join('- ERROR -')));
            } else if (line.includes('- CRITICAL -')) {
                const parts = line.split('- CRITICAL -');
                lineDiv.appendChild(document.createTextNode(parts[0]));
                const criticalSpan = document.createElement('span');
                criticalSpan.style.color = '#dc3545';
                criticalSpan.style.fontWeight = 'bold';
                criticalSpan.style.backgroundColor = '#f8d7da';
                criticalSpan.textContent = '- CRITICAL -';
                lineDiv.appendChild(criticalSpan);
                lineDiv.appendChild(document.createTextNode(parts.slice(1).join('- CRITICAL -')));
            } else if (line.includes('- WARNING -')) {
                const parts = line.split('- WARNING -');
                lineDiv.appendChild(document.createTextNode(parts[0]));
                const warningSpan = document.createElement('span');
                warningSpan.style.color = '#ffc107';
                warningSpan.style.fontWeight = 'bold';
                warningSpan.textContent = '- WARNING -';
                lineDiv.appendChild(warningSpan);
                lineDiv.appendChild(document.createTextNode(parts.slice(1).join('- WARNING -')));
            } else if (line.includes('- INFO -')) {
                const parts = line.split('- INFO -');
                lineDiv.appendChild(document.createTextNode(parts[0]));
                const infoSpan = document.createElement('span');
                infoSpan.style.color = '#17a2b8';
                infoSpan.textContent = '- INFO -';
                lineDiv.appendChild(infoSpan);
                lineDiv.appendChild(document.createTextNode(parts.slice(1).join('- INFO -')));
            } else if (line.includes('- DEBUG -')) {
                const parts = line.split('- DEBUG -');
                lineDiv.appendChild(document.createTextNode(parts[0]));
                const debugSpan = document.createElement('span');
                debugSpan.style.color = '#6c757d';
                debugSpan.textContent = '- DEBUG -';
                lineDiv.appendChild(debugSpan);
                lineDiv.appendChild(document.createTextNode(parts.slice(1).join('- DEBUG -')));
            } else {
                lineDiv.textContent = line;
            }

            logDiv.appendChild(lineDiv);
        });
    }

    function updateLineCount(count) {
        document.getElementById('lineCount').textContent = '(' + count + ' lines)';
    }

    document.getElementById('refreshBtn').addEventListener('click', function() {
        refreshLogs();
    });

    document.getElementById('autoRefreshToggle').addEventListener('click', function() {
        autoRefreshEnabled = !autoRefreshEnabled;
        const btn = document.getElementById('autoRefreshToggle');

        if (autoRefreshEnabled) {
            btn.textContent = 'Auto-Refresh: ON';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-success');

            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            autoRefreshInterval = setInterval(refreshLogs, interval);
        } else {
            btn.textContent = 'Auto-Refresh: OFF';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-secondary');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    });

    // Update refresh interval when changed
    document.getElementById('refreshInterval').addEventListener('change', function() {
        if (autoRefreshEnabled) {
            // Restart auto-refresh with new interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            const interval = parseInt(this.value) * 1000;
            autoRefreshInterval = setInterval(refreshLogs, interval);
        }
    });

    // Refresh logs when limit or level changes
    document.getElementById('limitSelector').addEventListener('change', refreshLogs);
    document.getElementById('levelFilter').addEventListener('change', refreshLogs);

    // Apply search filter when typing
    document.getElementById('searchFilter').addEventListener('input', applySearchFilter);

    // Auto-scroll to bottom on page load
    window.addEventListener('load', function() {
        const logDiv = document.getElementById('logContent');
        logDiv.scrollTop = logDiv.scrollHeight;

        // Color-code log levels
        colorCodeLogs(logDiv);

        // Store initial log lines
        allLogLines = logDiv.textContent.split('\n').filter(line => line.trim());
    });
</script>
{% endblock %}
