{% extends "base.html" %}

{% block title %}Host List{% endblock %}

{% block content %}
<h1 class="mb-4">Host List</h1>

<!-- New buttons for capturing all devices and file comparison -->
<div class="mb-3">
    <a href="{{ url_for('capture_all', base='origin') }}" class="btn btn-success btn-lg capture-btn">Capture Origin All</a>
    <a href="{{ url_for('capture_all', base='dest') }}" class="btn btn-primary btn-lg capture-btn">Capture Dest All</a>
    <a href="{{ url_for('compare_files') }}" class="btn btn-info btn-lg">Compare Files</a>
</div>

<!-- Search and Filter Controls -->
<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by hostname or IP address...">
    </div>
    <div class="col-md-6">
        <select id="statusFilter" class="form-control">
            <option value="all">All Devices</option>
            <option value="changes detected">Changes Detected</option>
            <option value="identical">Identical</option>
            <option value="file not found">File Not Found</option>
        </select>
    </div>
</div>

<table class="table table-striped table-bordered">
    <thead class="thead-dark">
        <tr>
            <th>Host</th>
            <th>IP Address</th>
            <th>Origin Info</th>
            <th>Dest Info</th>
            <th>Diff Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="hostTableBody">
    {% for host in hosts %}
        <tr class="host-row" data-hostname="{{ host.host }}" data-ip="{{ host.ip }}" data-status="{% for item in host.diff_info %}{{ item.status }}{% if not loop.last %},{% endif %}{% endfor %}">
            <td>{{ host.host }}</td>
            <td>{{ host.ip }}</td>
            <td>
                {% for item in host.origin_info %}
                    <div>
                        <strong>{{ item.command }}</strong><br>
                        <small>{{ item.mtime }}</small>
                    </div>
                {% endfor %}
            </td>
            <td>
                {% for item in host.dest_info %}
                    <div>
                        <strong>{{ item.command }}</strong><br>
                        <small>{{ item.mtime }}</small>
                    </div>
                {% endfor %}
            </td>
            <td>
                {% for item in host.diff_info %}
                    {% if item.status == "changes detected" %}
                        <span class="badge" style="background-color: #ffff99; font-weight: bold; color: black;">{{ item.command }}: {{ item.status }}</span>
                    {% elif item.status == "identical" %}
                        <span class="badge" style="background-color: #add8e6; font-weight: bold; color: black;">{{ item.command }}: {{ item.status }}</span>
                    {% else %}
                        <span class="badge badge-info">{{ item.command }}: {{ item.status }}</span>
                    {% endif %}
                {% endfor %}
            </td>
            <td>
                <a href="{{ url_for('capture', base='origin', hostname=host.host) }}" class="btn btn-success btn-sm mb-1 capture-btn">Capture Origin</a>
                <a href="{{ url_for('capture', base='dest', hostname=host.host) }}" class="btn btn-primary btn-sm mb-1 capture-btn">Capture Dest</a>
                <a href="{{ url_for('host_detail', hostname=host.host) }}" class="btn btn-secondary btn-sm mb-1">View Details</a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<script>
// Real-time search and filter functionality
(function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const hostRows = document.querySelectorAll('.host-row');

    function filterHosts() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;

        hostRows.forEach(function(row) {
            const hostname = row.getAttribute('data-hostname').toLowerCase();
            const ip = row.getAttribute('data-ip').toLowerCase();
            const statuses = row.getAttribute('data-status').toLowerCase();

            // Check search term (hostname or IP)
            const matchesSearch = hostname.includes(searchTerm) || ip.includes(searchTerm);

            // Check status filter
            let matchesStatus = true;
            if (statusValue !== 'all') {
                matchesStatus = statuses.includes(statusValue.toLowerCase());
            }

            // Show/hide row based on both criteria
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Add event listeners
    searchInput.addEventListener('input', filterHosts);
    statusFilter.addEventListener('change', filterHosts);
})();
</script>
{% endblock %}