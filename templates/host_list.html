{% extends "base.html" %}

{% block title %}Host List{% endblock %}

{% block content %}
<h1 class="mb-4">Host List</h1>

<!-- New buttons for capturing all devices and file comparison -->
<div class="mb-3">
    <form method="post" action="{{ url_for('capture_all', base='origin') }}" style="display: inline;" class="capture-all-form" data-base="origin">
        <button type="submit" class="btn btn-success btn-lg capture-all-btn">Capture Origin All</button>
    </form>
    <form method="post" action="{{ url_for('capture_all', base='dest') }}" style="display: inline;" class="capture-all-form" data-base="dest">
        <button type="submit" class="btn btn-primary btn-lg capture-all-btn">Capture Dest All</button>
    </form>
    <a href="{{ url_for('compare_files') }}" class="btn btn-info btn-lg">Compare Files</a>
</div>

<!-- Search and Filter Controls -->
<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by hostname or IP address...">
    </div>
    <div class="col-md-6">
        <select id="statusFilter" class="form-control">
            <option value="all">All Devices</option>
            <option value="changes detected">Changes Detected</option>
            <option value="identical">Identical</option>
            <option value="file not found">File Not Found</option>
        </select>
    </div>
</div>

<table class="table table-striped table-bordered">
    <thead class="thead-dark">
        <tr>
            <th>Host</th>
            <th>IP Address</th>
            <th>Origin Info</th>
            <th>Dest Info</th>
            <th>Diff Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="hostTableBody">
    {% for host in hosts %}
        <tr class="host-row" data-hostname="{{ host.host }}" data-ip="{{ host.ip }}" data-status="{% for item in host.diff_info %}{{ item.status }}{% if not loop.last %},{% endif %}{% endfor %}">
            <td>{{ host.host }}</td>
            <td>{{ host.ip }}</td>
            <td>
                {% for item in host.origin_info %}
                    <div>
                        <strong>{{ item.command }}</strong><br>
                        <small>{{ item.mtime }}</small>
                    </div>
                {% endfor %}
            </td>
            <td>
                {% for item in host.dest_info %}
                    <div>
                        <strong>{{ item.command }}</strong><br>
                        <small>{{ item.mtime }}</small>
                    </div>
                {% endfor %}
            </td>
            <td>
                {% for item in host.diff_info %}
                    {% if item.status == "changes detected" %}
                        <span class="badge" style="background-color: #ffff99; font-weight: bold; color: black;">{{ item.command }}: {{ item.status }}</span>
                    {% elif item.status == "identical" %}
                        <span class="badge" style="background-color: #add8e6; font-weight: bold; color: black;">{{ item.command }}: {{ item.status }}</span>
                    {% else %}
                        <span class="badge badge-info">{{ item.command }}: {{ item.status }}</span>
                    {% endif %}
                {% endfor %}
            </td>
            <td>
                <form method="post" action="{{ url_for('capture', base='origin', hostname=host.host) }}" style="display: inline;">
                    <button type="submit" class="btn btn-success btn-sm mb-1 capture-btn">Capture Origin</button>
                </form>
                <form method="post" action="{{ url_for('capture', base='dest', hostname=host.host) }}" style="display: inline;">
                    <button type="submit" class="btn btn-primary btn-sm mb-1 capture-btn">Capture Dest</button>
                </form>
                <a href="{{ url_for('host_detail', hostname=host.host) }}" class="btn btn-secondary btn-sm mb-1">View Details</a>
                <a href="{{ url_for('export_diff', hostname=host.host) }}" class="btn btn-warning btn-sm mb-1">Export</a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<script>
// Real-time search and filter functionality
(function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const hostRows = document.querySelectorAll('.host-row');

    function filterHosts() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value.toLowerCase();

        hostRows.forEach(function(row) {
            const hostname = (row.getAttribute('data-hostname') || '').toLowerCase();
            const ip = (row.getAttribute('data-ip') || '').toLowerCase();
            const statuses = (row.getAttribute('data-status') || '').toLowerCase();

            // Check search term (hostname or IP)
            const matchesSearch = hostname.includes(searchTerm) || ip.includes(searchTerm);

            // Check status filter - split by comma and check for exact match
            let matchesStatus = true;
            if (statusValue !== 'all') {
                const statusArray = statuses.split(',').map(s => s.trim());
                matchesStatus = statusArray.includes(statusValue);
            }

            // Show/hide row based on both criteria
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Add event listeners
    searchInput.addEventListener('input', filterHosts);
    statusFilter.addEventListener('change', filterHosts);
})();

// Confirmation dialog for "Capture All" actions
(function() {
    const captureAllForms = document.querySelectorAll('.capture-all-form');
    const totalDevices = {{ hosts|length }};

    captureAllForms.forEach(function(form) {
        form.addEventListener('submit', function(event) {
            const base = form.getAttribute('data-base');
            const baseLabel = base === 'origin' ? 'Origin' : 'Dest';

            const confirmMessage =
                '⚠️ WARNING: Capture All Operation ⚠️\n\n' +
                'You are about to capture data from ALL ' + totalDevices + ' device(s).\n\n' +
                'This operation will:\n' +
                '• Connect to all ' + totalDevices + ' devices sequentially\n' +
                '• Execute multiple commands on each device\n' +
                '• May take several minutes to complete\n' +
                '• Will overwrite existing ' + baseLabel + ' data\n\n' +
                'Are you sure you want to continue?';

            if (!confirm(confirmMessage)) {
                event.preventDefault();
                return false;
            }
        });
    });
})();
</script>
{% endblock %}
