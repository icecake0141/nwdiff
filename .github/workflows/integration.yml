# Copyright 2025 NW-Diff Contributors
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# This file was created or modified with the assistance of an AI (Large Language Model).
# Review required for correctness, security, and licensing.

name: Integration Tests

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  docker-integration:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment variables
        run: |
          # Generate secure tokens for testing
          echo "DEVICE_PASSWORD=test_device_pass_$(openssl rand -hex 8)" >> $GITHUB_ENV
          echo "NW_DIFF_API_TOKEN=$(python3 -c 'import secrets; print(secrets.token_urlsafe(32))')" >> $GITHUB_ENV
          echo "NW_DIFF_BASIC_USER=admin" >> $GITHUB_ENV
          echo "NW_DIFF_BASIC_PASSWORD=test_pass_$(openssl rand -hex 8)" >> $GITHUB_ENV
          echo "CERT_HOSTNAME=localhost" >> $GITHUB_ENV
          echo "APP_DEBUG=false" >> $GITHUB_ENV

      - name: Create test hosts.csv
        run: |
          # Create a minimal hosts.csv for testing
          cat > hosts.csv << 'EOF'
          hostname,ipaddress,port,username,device_type,commands
          test-device,192.0.2.1,22,admin,cisco_ios,"show version"
          EOF

      - name: Install dependencies for certificate and auth setup
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2-utils openssl

      - name: Generate TLS certificates and .htpasswd
        run: |
          # Run the automated init script to generate certificates and .htpasswd
          ./docker/nginx/init-certs-and-htpasswd.sh

      - name: Verify generated files
        run: |
          echo "Checking generated files..."
          test -f docker/certs/cert.pem || { echo "Certificate not found!"; exit 1; }
          test -f docker/certs/key.pem || { echo "Private key not found!"; exit 1; }
          test -f docker/.htpasswd || { echo ".htpasswd not found!"; exit 1; }
          echo "All required files generated successfully"

      - name: Create .env file for Docker Compose
        run: |
          cat > .env << EOF
          DEVICE_PASSWORD=${DEVICE_PASSWORD}
          NW_DIFF_API_TOKEN=${NW_DIFF_API_TOKEN}
          APP_DEBUG=false
          FLASK_RUN_HOST=0.0.0.0
          FLASK_RUN_PORT=5000
          EOF

      - name: Build Docker images
        run: |
          # Build with timeout and verbose output
          docker-compose build --progress=plain
        timeout-minutes: 15

      - name: Start Docker Compose stack
        run: |
          # Start services in detached mode
          docker-compose up -d
          
          # Wait for containers to be healthy
          echo "Waiting for containers to start..."
          sleep 10
          
          # Check container status
          docker-compose ps
          
          # Show logs for debugging
          echo "=== Flask app logs ==="
          docker-compose logs nw-diff
          echo "=== Nginx logs ==="
          docker-compose logs nginx

      - name: Check service health
        run: |
          # Wait for services to be healthy
          timeout=60
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            if docker-compose ps | grep -q "Up (healthy)"; then
              echo "Services are healthy"
              docker-compose ps
              exit 0
            fi
            echo "Waiting for services to be healthy... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          
          echo "Services did not become healthy in time"
          docker-compose ps
          docker-compose logs
          exit 1

      - name: Run integration tests
        env:
          HTTPS_URL: https://localhost
          HTTP_URL: http://localhost
          NW_DIFF_BASIC_USER: admin
          NW_DIFF_BASIC_PASSWORD: ${{ env.NW_DIFF_BASIC_PASSWORD }}
          NW_DIFF_API_TOKEN: ${{ env.NW_DIFF_API_TOKEN }}
        run: |
          # Run the integration test script
          ./scripts/test-integration.sh

      - name: Test HTTPS endpoint with curl (verbose)
        if: always()
        run: |
          echo "=== Testing HTTPS endpoint ==="
          curl -k -v -u "admin:${NW_DIFF_BASIC_PASSWORD}" https://localhost/ || true
          
          echo ""
          echo "=== Testing HTTP redirect ==="
          curl -v http://localhost/ || true

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Status ==="
          docker-compose ps
          
          echo ""
          echo "=== Flask App Logs ==="
          docker-compose logs nw-diff
          
          echo ""
          echo "=== Nginx Logs ==="
          docker-compose logs nginx
          
          echo ""
          echo "=== Container Inspect ==="
          docker inspect nw-diff-app || true
          docker inspect nw-diff-nginx || true

      - name: Cleanup Docker Compose stack
        if: always()
        run: |
          docker-compose down -v
          docker-compose ps

  unit-and-integration-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt -r requirements-dev.txt

      - name: Run pytest (unit and integration tests)
        run: |
          pytest -v

      - name: Run mypy (type checking)
        run: |
          mypy src tests

      - name: Run pylint (linting)
        run: |
          pylint src tests

      - name: Run black (format check)
        run: |
          black --check src tests
